// extension/popup.jsx
import React, { useEffect, useState } from "react";
import { createRoot } from "react-dom/client";
import { X, Loader2 } from "lucide-react";
import { auth, db, signInWithGoogle, signOutUser } from "/utils/firebaseInit.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const Popup = () => {
  const [user, setUser] = useState(null);
  const [data, setData] = useState(null);
  const [view, setView] = useState("settings");
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(true);

  // Prevent accidental close
  useEffect(() => {
    window.addEventListener("blur", () => window.focus());
  }, []);

  useEffect(() => {
    const unsub = auth.onAuthStateChanged(async (u) => {
      if (u) {
        setUser(u);
        await fetchUserData(u);
      } else {
        setLoading(false);
      }
    });
    return () => unsub();
  }, []);

  async function fetchUserData(u) {
    try {
      const ref = doc(db, "aeryth_data", u.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) setData(snap.data());
      else setData({ routines: [], settings: {} });
    } catch (e) {
      console.error(e);
      setError("Failed to load data");
    } finally {
      setLoading(false);
    }
  }

  async function handleSignIn() {
    try {
      setLoading(true);
      const user = await signInWithGoogle();
      setUser(user);
      await fetchUserData(user);
    } catch (e) {
      console.error(e);
      setError("Sign-in failed. Please try again.");
      setLoading(false);
    }
  }

  async function handleSignOut() {
    await signOutUser();
    setUser(null);
    setData(null);
    setView("settings");
  }

  if (loading) {
    return (
      <div className="flex flex-col items-center justify-center bg-gradient-to-b from-violet-500 to-violet-700 text-white rounded-xl w-[320px] h-[420px]">
        <Loader2 className="animate-spin mb-2" size={28} />
        <p>Loading Firebase...</p>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="flex flex-col items-center justify-center bg-gradient-to-b from-violet-500 to-violet-700 text-white rounded-xl w-[320px] h-[420px] text-center p-4">
        <h3 className="text-lg font-semibold mb-2">Welcome to Aeryth</h3>
        <p className="text-sm opacity-80 mb-3">Sign in with Google to continue</p>
        {error && <p className="text-red-200 text-xs mb-2">{error}</p>}
        <button
          onClick={handleSignIn}
          className="bg-white text-violet-600 font-semibold rounded-lg px-4 py-2"
        >
          Sign in with Google
        </button>
      </div>
    );
  }

  const today = new Date().toISOString().slice(0, 10);
  const upcoming = (data?.aeryth_routines || []).filter(r => r.date === today).slice(0, 3);

  return (
    <div
      style={{
        width: 320,
        height: 420,
        background: "linear-gradient(180deg, #8b5cf6, #7c3aed)",
        color: "white",
        display: "flex",
        borderRadius: 12,
        overflow: "hidden",
        fontFamily: "system-ui",
        position: "relative",
      }}
    >
      <div
        style={{
          position: "absolute",
          top: 6,
          right: 6,
          cursor: "pointer",
        }}
        onClick={() => window.close()}
      >
        <X size={16} />
      </div>

      {/* Sidebar */}
      <div
        style={{
          width: 50,
          background: "rgba(255,255,255,0.1)",
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
          justifyContent: "space-around",
          padding: "6px 0",
        }}
      >
        {[
          ["ðŸ“…", "Events", () => setView("events")],
          ["ðŸ—“ï¸", "Calendar", () => setView("calendar")],
          ["âš™ï¸", "Settings", () => setView("settings")],
          ["ðŸŒ", "Web", () => chrome.tabs.create({ url: "https://aeryth01.web.app/" })],
        ].map(([icon, title, onClick]) => (
          <div
            key={title}
            onClick={onClick}
            title={title}
            style={{
              cursor: "pointer",
              fontSize: 18,
              opacity: view === title.toLowerCase() ? 1 : 0.8,
            }}
          >
            {icon}
          </div>
        ))}
      </div>

      {/* Main content */}
      <div style={{ flex: 1, padding: 10, overflowY: "auto" }}>
        {view === "events" && (
          <>
            <h3>Today's Events</h3>
            {upcoming.length ? (
              upcoming.map((r) => (
                <div
                  key={r.id}
                  style={{
                    marginBottom: 8,
                    padding: 6,
                    background: "rgba(255,255,255,0.15)",
                    borderRadius: 6,
                  }}
                >
                  <div style={{ fontWeight: 600 }}>{r.name}</div>
                  <div style={{ fontSize: 12 }}>{r.startTime} - {r.endTime}</div>
                </div>
              ))
            ) : (
              <div style={{ fontSize: 12, opacity: 0.7 }}>No events today.</div>
            )}
          </>
        )}

        {view === "calendar" && (
          <div>
            <h3>Calendar</h3>
            <p style={{ opacity: 0.8, fontSize: 12 }}>Calendar view coming soon.</p>
          </div>
        )}

        {view === "settings" && (
          <div>
            <h3>Settings</h3>
            <p style={{ fontSize: 13, marginBottom: 6 }}>
              Signed in as <b>{user.displayName}</b>
            </p>
            <button
              onClick={handleSignOut}
              style={{
                background: "white",
                color: "#7c3aed",
                fontWeight: 600,
                padding: "6px 12px",
                border: "none",
                borderRadius: 6,
                cursor: "pointer",
              }}
            >
              Sign out
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

createRoot(document.getElementById("root")).render(<Popup />);
